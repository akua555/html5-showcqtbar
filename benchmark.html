<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="UTF-8"/>
        <title>ShowCQTBar Benchmark</title>
        <script type="text/javascript" src="showcqtbar.js"></script>
        <script>/*<![CDATA[*/
            function pad_string(arg, len) {
                var str = "" + arg;
                while (str.length < len)
                    str = " " + str;
                return str;
            }

            function benchmark() {
                var width = 960;
                var height = 540/4;
                var height_mul = 1;
                var rate = 48000;
                var inner_count = 40;
                var outer_count = 10;
                var count = 0;
                var calc_time = 0;
                var render_time = 0;
                var cqt = null;
                var input = [ null, null ];
                var output = null;

                function bench_inner() {
                    if (!cqt) {
                        cqt = new ShowCQTBar(rate, width, height*height_mul - 1, 17, 17, 1);
                        input[0] = cqt.get_input_array(0);
                        input[1] = cqt.get_input_array(1);
                        output = cqt.get_output_array();
                        for (var x = 0; x <input[0].length; x++) {
                            input[0][x] = 0.3 * Math.sin(0.0001 * (x*x));
                            input[1][x] = 0.3 * Math.cos(0.00005 * (x*x));
                        }
                    }

                    var time = performance.now();
                    for (var k = 0; k < inner_count; k++)
                        cqt.calc();
                    calc_time += performance.now() - time;

                    time = performance.now();
                    for (var k = 0; k < inner_count; k++) {
                        for (var y = 0; y < height*height_mul; y++)
                            cqt.render_line(y);
                    }
                    render_time += performance.now() - time;

                    count++;
                    if (count >= outer_count) {
                        cqt = null;
                        document.getElementById("result").textContent +=
                            pad_string(width, 4) + " x " + pad_string(height*height_mul, 4) + " :   calc = " +
                            pad_string(Math.round(calc_time*1000/(inner_count*outer_count)), 5) + " μs,   render = " +
                            pad_string(Math.round(render_time*1000/(inner_count*outer_count)), 7) + " μs\n";
                        height_mul *= 2;
                        if (height_mul > 4) {
                            width += 320;
                            height += 45;
                            height_mul = 1;
                            document.getElementById("result").textContent +=
                                "------------------------------------------------------\n";
                        }
                        count = calc_time = render_time = 0;
                    }

                    if (width <= 4*1920)
                        setTimeout(bench_inner, 100);
                    else
                        document.getElementById("result").textContent += "Complete.";
                }
                setTimeout(bench_inner, 100);
            }
        /*]]>*/</script>
    </head>
    <body onload="benchmark()">
        <pre id="result">ShowCQTBar Benchmark:
</pre>
    </body>
</html>
